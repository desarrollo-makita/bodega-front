<div class="main-content">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-md-12">

        <!-- Resumen de Garantías -->
        <div class="card-garantias mat-elevation-z8 animate-fadeIn">
          <h2 class="highlight-text">
            Tienes <span class="cantidad">{{ garantiaData.length }}</span> garantías pendientes
            <!-- <span *ngIf="garantiaPendiente > 0" class="estado pendiente">Pendientes: {{ garantiaPendiente }}</span> - 
            <span class="estado aprobado">Aprobadas: {{ garantiaAprobada }}</span> -
            <span class="estado rechazado">Rechazadas: {{ garantiaRechazada }}</span> -->
          </h2>
          <div class="filtro-estado mb-3">
            <mat-form-field appearance="outline" class="filtro-combo">
              <mat-label>Filtrar por estado</mat-label>
              <mat-select [(value)]="estadoSeleccionado" (selectionChange)="validarFiltros()"  [disabled]="bloquearCombo">
             
                <mat-option value="pendientes">Garantias Abiertas</mat-option>
                <mat-option value="cerradas">Garantias Cerradas</mat-option>
                <mat-option value="ingresada">Garantias Ingresadas</mat-option>
                 <mat-option value="pendientesIncompletas">Garantias Pendientes</mat-option>
              
               
              </mat-select>
            </mat-form-field>
          </div>
          <!-- Filtro por Fecha -->
        <div class="filtro-fecha mb-3 d-flex align-items-center">
          <mat-form-field appearance="outline" class="filtro-fecha-campo">
            <mat-label>Fecha desde</mat-label>
            <input matInput [matDatepicker]="pickerDesde" [(ngModel)]="fechaDesde">
            <mat-datepicker-toggle matSuffix [for]="pickerDesde"></mat-datepicker-toggle>
            <mat-datepicker #pickerDesde></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filtro-fecha-campo ml-3">
            <mat-label>Fecha hasta</mat-label>
            <input matInput [matDatepicker]="pickerHasta" [(ngModel)]="fechaHasta">
            <mat-datepicker-toggle matSuffix [for]="pickerHasta"></mat-datepicker-toggle>
            <mat-datepicker #pickerHasta></mat-datepicker>
          </mat-form-field>

          <button mat-raised-button color="primary" class="ml-3" (click)="filtrarPorFecha()">
            Filtrar por fecha
          </button>

          
        </div>

        </div>
        
        <div *ngIf="isLoading" class="loading">
          <mat-spinner diameter="50" style="margin: auto;"></mat-spinner>
           <p style="text-align: center;">{{mensajeCarga}}</p>
        </div>
        
        
        
        
        <div *ngIf="!isLoading && garantiaData.length > 0" class="card-garantias-tabla mat-elevation-z8 animate-fadeIn">
          <!-- Tabla de Garantías usada para pedidos abiertos-->
          <div *ngIf="!showIntranet" class="table-container mat-elevation-z4 animate-slideIn">
            <table class="table table-hover table-striped">
              <thead>
                <tr>
                  <th>Llamada Servicio</th>
                  <th>Rut ST Autorizado</th>
                  <th>Nombre Serv. Autorizado</th>
                  <th>Tipo Documento</th>
                  <th>Estado</th>
                  <th *ngIf="mostrarAcciones">Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let garantia of garantiaData">
                  <td (click)="abrirDetalleGarantia(garantia)" class="clickable-cell">
                    {{ garantia.ServiceCallID }}
                  </td>
                  <td>{{ garantia.CustomerCode }}</td>
                  <td>{{ garantia.CustomerName }}</td>
                  <td>{{ garantia.CallType === 3 ?'Garantia' :  'Ventas' }}</td>
                  <td>
                    <span [ngClass]="{
                      'pendiente': garantia.Status === -3,
                      'aprobado': garantia.Status === 'Aprobado',
                      'rechazado': garantia.Status === -1,
                      'pendientesIncompletas': garantia.Status === -2
                    }">
                     {{ garantia.Status === -3 ? 'Abierta' : 
                        garantia.Status === -1 ? 'Cerrada' : 
                        garantia.Status === -2 ? 'Pendiente e incompleta' :
                        garantia.Status }}

                    </span>
                  </td>
                  <td>
                    <button  *ngIf="garantia.TipoDocumento === 'PRESUPUESTO'"
                      mat-icon-button
                      class= "icono-editar"
                      (click)="abrirModalAgregarRepuestoOT(garantia)"
                      matTooltip="Editar OT">
                      <mat-icon>edit</mat-icon>
                    </button>
                    
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Tabla de Garantías usada para pedidos ingresados -->
          <div *ngIf="showIntranet" class="table-container mat-elevation-z4 animate-slideIn">
            <table class="table table-hover table-striped">
              <thead>
                <tr>
                  <th>Folio</th>
                  <th>Pedido</th>
                  <th>Nombre Servicio Técnico</th>
                  <th>Nombre Cliente</th>
                  <th>Descripción Item</th>
                  <th>Item Modelo</th>
                  <th>N° Serie</th>
                  <th>Tipo Documento</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let garantia of garantiaData">
                  <!--<td (click)="abrirDetalleGarantia(garantia)" class="clickable-cell"> -->
                  <td>
                    {{ garantia.Folio }}
                  </td>
                  <td >
                    {{ garantia.Id_Pedido }}
                  </td>
                  <td >
                    {{ garantia.NombreServicioAut }}
                  </td>
                  <td >
                    {{ garantia.NombreConsumidor }}
                  </td>
                   <td >
                    {{ garantia.DescripcionHerramienta }}
                  </td>
                  <td >
                    {{ garantia.Referencia }}
                  </td>
                  <td>
                    {{ garantia.Serie }}
                  </td>
                  <td>
                    {{garantia.TipoDocumento}}
                  </td>
                  <td>
                    <button
                      mat-icon-button
                      class="boton-agregar"
                      (click)="abrirModalAgregarRepuesto(garantia)"
                      matTooltip="Agregar Repuesto">
                      <mat-icon>add_circle</mat-icon>
                    </button>

                    <button *ngIf="garantia?.Id_Pedido != null && garantia?.documentos?.length > 0 && garantia?.detalle?.length > 0"
                      mat-icon-button
                      class="boton-enviar-sap"
                      (click)="enviarASAP(garantia)"
                      matTooltip="Enviar a SAP">
                      <mat-icon class="icono-azul">cloud_upload</mat-icon>
                    </button>

                     <button
                      mat-icon-button
                      class="boton-pdf"
                      (click)="descargarVoucher(garantia)"
                      matTooltip="Descargar Voucher PDF">
                      <mat-icon class="icono-rojo">picture_as_pdf</mat-icon>
                    </button>
                    
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

